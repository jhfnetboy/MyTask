# 架构决策记录 (Architecture Decision Records)

## ADR-001: 采用 Hubble AI Trading 作为 AI 代理基础

**状态**: ✅ 已接受

**背景**:
MyTask 需要为四个角色 (Sponsor, Taskor, Supplier, Jury) 提供 AI 驱动的决策辅助。传统的单一代理系统无法处理复杂的多角色协调与风险管理。

**问题陈述**:
1. 需要灵活的多代理编排框架
2. 需要生产级的风险管理机制
3. 需要实时监控与可视化
4. 需要类型安全的数据流

**选项**:
- A: 自研完整系统 (高成本、低复用)
- B: 采用 Hubble AI Trading 框架 (✅ 选中)
- C: 集成第三方 API 服务 (高成本、低定制性)

**决策**:
采用 Hubble AI Trading 作为基础框架，原因：
- ✅ 已验证的多代理架构 (5 个协作代理)
- ✅ 生产级风险管理
- ✅ 边缘计算优化 (Sub-50ms)
- ✅ 完整的前端实现
- ✅ 开源 MIT 许可

**影响**:
- 开发时间减少 40%
- 获得成熟的风险管理系统
- 继承 Cloudflare 边缘计算能力
- 长期维护成本降低

**后续关注**:
- 定期升级 Hubble 核心代码
- 贡献改进回上游
- 监控安全更新

---

## ADR-002: 支持 LangGraph 作为多代理编排引擎

**状态**: ✅ 已接受

**背景**:
MyTask 的四个角色需要实时协调：Sponsor 的成本决策影响 Taskor 的报价，而 Supplier 的定价影响两者。这需要一个能处理循环依赖的图形编排系统。

**问题陈述**:
1. 线性代理管道不足以处理循环依赖
2. 需要有状态的代理间通信
3. 需要支持条件执行分支
4. 需要可视化调试工具

**选项**:
- A: 自研任务队列系统 (低复用、高维护)
- B: 使用 LangGraph (✅ 选中)
- C: 使用 Airflow (过度工程)

**决策**:
使用 LangGraph 因为：
- ✅ 原生支持有向图工作流
- ✅ LangChain 生态集成
- ✅ 内置状态管理
- ✅ 可视化支持
- ✅ 支持人工在环 (HITL) 评审

**架构**:
```
LangGraph State Machine
├─ State: TaskMarketAnalysis
├─ State: RiskAssessment
├─ State: PortfolioDecision
├─ State: TradeExecution
└─ State: PerformanceAnalysis
```

**影响**:
- 复杂的决策流可以清晰表达
- 便于单元测试与调试
- 支持异步执行优化

---

## ADR-003: 使用 Cloudflare Workers 作为边缘计算平台

**状态**: ✅ 已接受

**背景**:
MyTask 交易系统需要低延迟响应，实时数据推送，以及高可用性。传统的中心化服务器难以满足这些需求。

**问题陈述**:
1. 全球用户需要低延迟 (<100ms)
2. 实时市场数据推送
3. 自动扩展与无服务器
4. 成本优化

**选项**:
- A: 传统中心化服务器 (高延迟、低扩展性)
- B: 多区域自管理 (高成本、高复杂度)
- C: Cloudflare Workers (✅ 选中)

**决策**:
使用 Cloudflare Workers 因为：
- ✅ Sub-50ms 全球响应
- ✅ Zero cold start
- ✅ SQLite D1 数据库
- ✅ KV 高速缓存
- ✅ DDoS 防护内置

**架构**:
```
Cloudflare Global Network
├─ Edge Runtime (Workers)
├─ Edge Database (D1)
├─ Edge Cache (KV)
├─ Analytics Engine
└─ Email Service
```

**影响**:
- 全球用户获得一致的低延迟体验
- 成本按请求数计费
- 自动地理位置路由
- 内置安全防护

**注意**:
- 长连接 (WebSocket) 有限制
- 需要适配边缘函数的约束
- 开发工具成熟度需要评估

---

## ADR-004: 按角色的功能模块化设计

**状态**: ✅ 已接受

**背景**:
MyTask 有四个不同的角色，每个都有独特的业务逻辑、数据模型和 UI 需求。单一的单体应用会变得不可维护。

**问题陈述**:
1. 四个角色有完全不同的需求
2. 独立开发与测试很困难
3. 代码复用与共享的困难
4. 团队协作与并行开发

**选项**:
- A: 单一应用 (低可维护性)
- B: 微前端架构 (高复杂性)
- C: 功能模块化设计 (✅ 选中)

**决策**:
采用功能模块化设计：
```
app/features/
├── sponsor-trading/
│   ├── database/
│   ├── api/
│   ├── hooks/
│   ├── components/
│   └── index.ts
├── taskor-trading/
├── supplier-trading/
├── jury-trading/
└── trading-common/    # 共享功能
```

**优势**:
- ✅ 清晰的界限与职责
- ✅ 独立的团队开发
- ✅ 代码复用via共享模块
- ✅ 便于单元测试
- ✅ 易于添加新功能

**共享模式**:
```
Types & Schemas (共享)
├─ database/          (仅服务器)
├─ api/               (仅服务器)
├─ hooks/             (客户端安全)
├─ components/        (客户端)
└─ lib/               (通用)
```

---

## ADR-005: 集成 Payload Exchange 的 x402 支付模式

**状态**: ✅ 已接受

**背景**:
MyTask 中的任务创建与赞助需要灵活的支付模式。单一的代币支付限制了用户基础。x402 协议提供了一个标准化的 HTTP 支付方式。

**问题陈述**:
1. 不是所有用户都持有加密货币
2. 支付方式需要多样化
3. 需要赞助商与用户的协调机制
4. 跨链支付的互操作性

**选项**:
- A: 仅支持 USDC 支付 (有限、排他)
- B: 自研支付系统 (高风险、低标准化)
- C: 集成 Payload Exchange + x402 (✅ 选中)

**决策**:
采用 Payload Exchange 的 x402 支付架构：
- ✅ 标准化的 HTTP 402 协议
- ✅ 支付拦截与重定向
- ✅ 赞助商匹配机制
- ✅ 多币种支持
- ✅ ZK 验证信任

**架构**:
```
用户请求任务
    ↓
x402 支付拦截 (402 Payment Required)
    ↓
Payload Exchange 代理
    ├─ 选项 A: USDC 支付
    ├─ 选项 B: 关注社媒
    └─ 选项 C: 提供数据
    ↓
赞助商预融资支付
    ↓
用户获得任务访问权
```

**集成点**:
- 任务创建时生成 x402 支付墙
- Sponsor 可以设置支付选项
- Taskor 可以选择支付方式
- Supplier 获得支付保证

---

## ADR-006: 多币种与跨链支持

**状态**: ✅ 已接受

**背景**:
MyTask 作为全球协议需要支持多种加密资产与多条区块链。单一链与币种限制了参与者基础。

**问题陈述**:
1. 用户持有不同的代币
2. 流动性分散在多条链上
3. 需要最优路由与汇率
4. 结算确定性与安全性

**选项**:
- A: 仅支持单条链 (限制性)
- B: 支持多链但统一结算 (复杂)
- C: 多币种跨链支持 (✅ 选中)

**决策**:
多币种跨链架构：
```
支持的区块链
├─ Ethereum (主流)
├─ Base (Coinbase)
├─ Polygon (扩展性)
├─ Arbitrum (低成本)
└─ Optimism (多VM)

支持的代币
├─ USDC / USDT (稳定币)
├─ ETH / WETH (原生资产)
├─ 其他主流 ERC20
└─ 自定义代币 (OpenPNTs)
```

**路由策略**:
- 智能聚合器选择最优路由
- 自动 DEX 与桥接选择
- 滑点最小化
- 实时汇率更新

**实现**:
- 集成 1inch / 0x 聚合器
- Stargate / Hyperlane 跨链
- Chainlink 喂价
- Uniswap V4 路由

---

## ADR-007: 风险管理三层模型

**状态**: ✅ 已接受

**背景**:
自主交易系统容易产生灾难性损失。需要一个多层的风险防护机制来保护用户资产。

**问题陈述**:
1. AI 决策可能出错
2. 市场剧烈波动
3. 对手方风险
4. 系统故障风险

**选项**:
- A: 无风险控制 (不可接受)
- B: 单层防护 (不足够)
- C: 三层风险模型 (✅ 选中)

**决策**:
三层风险管理模型：

```
Layer 1: 预防层 (Prevention)
├─ 头寸规模限制
├─ 杠杆上限
├─ 波动率检测
└─ 黑名单地址

Layer 2: 检测层 (Detection)
├─ 实时风险评分
├─ 异常检测
├─ 对手方监控
└─ 流动性风险

Layer 3: 响应层 (Response)
├─ 自动平仓 (emergency)
├─ 风险告警
├─ 人工审批
└─ 争议仲裁
```

**实现**:
```python
# Risk Manager Agent
- calculate_position_size(capital, volatility)
- monitor_counterparty_risk(address)
- detect_anomalies(trading_pattern)
- trigger_emergency_close(if conditions_met)
```

---

## ADR-008: AI 透明度与可审计性

**状态**: ✅ 已接受

**背景**:
自主 AI 交易系统的决策需要完全可审计与透明。用户需要理解为什么系统做出特定的决策。

**问题陈述**:
1. "黑盒"AI 决策导致不信任
2. 监管要求可审计性
3. 争议解决需要完整记录
4. 持续改进需要分析

**选项**:
- A: 最小日志记录 (快速但不可审)
- B: 完整日志存储 (存储成本高)
- C: 智能审计架构 (✅ 选中)

**决策**:
完整的决策审计追踪：

```
每个交易决策记录:
├─ Input: 市场数据、头寸、风险参数
├─ Agent: 参与决策的代理及其输出
├─ Decision: 最终决策与推理
├─ Execution: 执行结果与成本
├─ Outcome: 交易结果与 P&L
└─ Timestamp: 完整的时间戳

存储策略:
├─ 实时: 近期交易 (Cloudflare KV)
├─ 热存储: 当月数据 (D1)
├─ 冷存储: 历史数据 (S3)
└─ Archive: 长期保存 (IPFS)
```

**可审计性**:
- 决策树可视化
- 代理对话回放
- 参数变化追踪
- 风险指标时间序列

---

## ADR-009: 社区治理与 DAO 集成

**状态**: 🔄  规划中

**背景**:
长期来看，MyTask 应该演变为一个由社区治理的协议。中心化决策可能不适合全球去中心化平台。

**问题陈述**:
1. 参数调整需要透明的治理
2. 费用与激励需要社区同意
3. 升级与新功能需要民主决策
4. 争议仲裁需要公平机制

**初步选项**:
- A: 完全中心化 (不符合 Web3 精神)
- B: 混合治理 (权力分散)
- C: 完全 DAO (长期目标)

**规划方向**:
1. **Phase 1 (6 个月)**: 中心化但透明
   - 公开所有参数
   - 社区讨论与建议
   - 定期更新日志

2. **Phase 2 (12 个月)**: 社区治理
   - 治理代币 ($TASK)
   - 多签钱包
   - 提案与投票机制

3. **Phase 3 (18 个月)**: 完整 DAO
   - 国库管理
   - 委托人选举
   - 争议法庭

---

## ADR-010: 隐私与合规考量

**状态**: ✅ 已接受

**背景**:
MyTask 涉及真实的经济激励与用户数据。需要符合各地的隐私与反洗钱规定。

**问题陈述**:
1. 用户隐私保护
2. KYC/AML 合规
3. 数据跨境限制
4. 地域法规差异

**设计原则**:
1. **隐私优先**:
   - 最小数据收集
   - E2E 加密选项
   - 数据保留政策
   - 用户 GDPR 权利

2. **合规架构**:
   - 可选的 KYC 流程
   - AML 风险评分
   - 交易限额
   - 监管报告

3. **技术实现**:
   - Zero-knowledge proofs
   - 隐私代币支持
   - 混合器整合
   - 链上隐私

**注意**:
- 与法律顾问协作
- 定期合规审计
- 区域差异化配置

---

## 决策汇总表

| ADR | 决策 | 状态 | 影响 |
|-----|------|------|------|
| 001 | Hubble AI Trading | ✅ 接受 | 架构基础 |
| 002 | LangGraph 编排 | ✅ 接受 | 高级编排 |
| 003 | Cloudflare Workers | ✅ 接受 | 全球低延迟 |
| 004 | 功能模块化 | ✅ 接受 | 开发效率 |
| 005 | x402 支付 | ✅ 接受 | 多样支付 |
| 006 | 跨链多币种 | ✅ 接受 | 全球覆盖 |
| 007 | 三层风险模型 | ✅ 接受 | 安全性 |
| 008 | 完整审计追踪 | ✅ 接受 | 透明度 |
| 009 | DAO 治理 | 🔄 规划 | 长期演进 |
| 010 | 隐私合规 | ✅ 接受 | 法规符合 |

---

## 后续决策需要

- [ ] ADR-011: 跨链原子性交换机制
- [ ] ADR-012: AI 模型更新与版本管理
- [ ] ADR-013: 性能 SLA 与监控
- [ ] ADR-014: 争议仲裁机制
- [ ] ADR-015: 社区激励与空投计划

---

**文档维护**: 每个决策应在实施前经过审查，并在后续迭代中更新。

**最后更新**: 2025-11-26
